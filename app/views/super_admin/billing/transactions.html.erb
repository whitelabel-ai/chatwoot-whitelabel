<% content_for :page_title do %>
  Billing Transactions
<% end %>

<div class="row">
  <div class="medium-12 columns">
    <div class="page-top-bar">
      <h2 class="page-title">Billing Transactions</h2>
      <div class="page-top-bar__actions">
        <%= link_to "Back to Billing", super_admin_billing_index_path, class: "button secondary" %>
        <%= link_to "Export CSV", super_admin_billing_transactions_path(format: :csv, **request.query_parameters), class: "button primary" %>
      </div>
    </div>
  </div>
</div>

<!-- Summary Cards -->
<div class="row">
  <div class="medium-3 columns">
    <div class="summary-card success">
      <div class="summary-number"><%= number_to_currency(@summary[:successful_amount]) %></div>
      <div class="summary-label">Successful Payments</div>
      <div class="summary-count"><%= @summary[:successful_count] %> transactions</div>
    </div>
  </div>
  <div class="medium-3 columns">
    <div class="summary-card danger">
      <div class="summary-number"><%= number_to_currency(@summary[:failed_amount]) %></div>
      <div class="summary-label">Failed Payments</div>
      <div class="summary-count"><%= @summary[:failed_count] %> transactions</div>
    </div>
  </div>
  <div class="medium-3 columns">
    <div class="summary-card warning">
      <div class="summary-number"><%= number_to_currency(@summary[:pending_amount]) %></div>
      <div class="summary-label">Pending Payments</div>
      <div class="summary-count"><%= @summary[:pending_count] %> transactions</div>
    </div>
  </div>
  <div class="medium-3 columns">
    <div class="summary-card primary">
      <div class="summary-number"><%= number_to_currency(@summary[:total_amount]) %></div>
      <div class="summary-label">Total Volume</div>
      <div class="summary-count"><%= @summary[:total_count] %> transactions</div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="row">
  <div class="medium-12 columns">
    <div class="card">
      <div class="card-header">
        <h3>Filters</h3>
      </div>
      <div class="card-body">
        <%= form_with url: super_admin_billing_transactions_path, method: :get, local: true, class: "filters-form" do |form| %>
          <div class="row">
            <div class="medium-3 columns">
              <%= form.label :status, "Status" %>
              <%= form.select :status, 
                              options_for_select([
                                ['All Statuses', ''],
                                ['Successful', 'successful'],
                                ['Failed', 'failed'],
                                ['Pending', 'pending']
                              ], params[:status]),
                              {}, { class: 'form-control' } %>
            </div>
            <div class="medium-3 columns">
              <%= form.label :plan_id, "Plan" %>
              <%= form.select :plan_id, 
                              options_for_select([
                                ['All Plans', '']
                              ] + @plans.map { |p| [p.name, p.id] }, params[:plan_id]),
                              {}, { class: 'form-control' } %>
            </div>
            <div class="medium-2 columns">
              <%= form.label :start_date, "Start Date" %>
              <%= form.date_field :start_date, value: params[:start_date], class: 'form-control' %>
            </div>
            <div class="medium-2 columns">
              <%= form.label :end_date, "End Date" %>
              <%= form.date_field :end_date, value: params[:end_date], class: 'form-control' %>
            </div>
            <div class="medium-2 columns">
              <%= form.label :search, "Search" %>
              <%= form.text_field :search, placeholder: "Account name...", value: params[:search], class: 'form-control' %>
            </div>
          </div>
          <div class="row">
            <div class="medium-12 columns">
              <div class="filter-actions">
                <%= form.submit "Apply Filters", class: "button primary" %>
                <%= link_to "Clear Filters", super_admin_billing_transactions_path, class: "button secondary" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Transactions Table -->
<div class="row">
  <div class="medium-12 columns">
    <div class="card">
      <div class="card-header">
        <h3>Transactions (<%= @transactions.total_count %>)</h3>
      </div>
      <div class="card-body">
        <% if @transactions.any? %>
          <div class="table-container">
            <table class="transactions-table">
              <thead>
                <tr>
                  <th>Transaction ID</th>
                  <th>Account</th>
                  <th>Plan</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Payment Gateway</th>
                  <th>Gateway Transaction ID</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @transactions.each do |transaction| %>
                  <tr class="transaction-row <%= transaction.status %>">
                    <td>
                      <span class="transaction-id">#<%= transaction.id %></span>
                    </td>
                    <td>
                      <div class="account-info">
                        <strong><%= transaction.account.name %></strong>
                        <small class="account-id">#<%= transaction.account.id %></small>
                      </div>
                    </td>
                    <td>
                      <% if transaction.billing_plan %>
                        <div class="plan-info">
                          <strong><%= transaction.billing_plan.name %></strong>
                          <small class="plan-limit"><%= number_with_delimiter(transaction.billing_plan.monthly_message_limit) %> msgs</small>
                        </div>
                      <% else %>
                        <span class="no-plan">No Plan</span>
                      <% end %>
                    </td>
                    <td>
                      <div class="amount-info">
                        <strong class="amount"><%= number_to_currency(transaction.amount) %></strong>
                        <small class="currency"><%= transaction.currency %></small>
                      </div>
                    </td>
                    <td>
                      <span class="badge <%= transaction.status %>">
                        <%= transaction.status.humanize %>
                      </span>
                      <% if transaction.status == 'failed' && transaction.failure_reason.present? %>
                        <small class="failure-reason"><%= transaction.failure_reason %></small>
                      <% end %>
                    </td>
                    <td>
                      <span class="gateway"><%= transaction.payment_gateway.humanize %></span>
                    </td>
                    <td>
                      <% if transaction.gateway_transaction_id.present? %>
                        <span class="gateway-id"><%= transaction.gateway_transaction_id %></span>
                      <% else %>
                        <span class="no-gateway-id">-</span>
                      <% end %>
                    </td>
                    <td>
                      <div class="date-info">
                        <strong><%= transaction.created_at.strftime('%m/%d/%Y') %></strong>
                        <small class="time"><%= transaction.created_at.strftime('%I:%M %p') %></small>
                      </div>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <%= link_to "View", super_admin_billing_transaction_path(transaction), class: "button tiny secondary" %>
                        <% if transaction.status == 'pending' %>
                          <%= link_to "Mark Success", super_admin_billing_mark_transaction_successful_path(transaction), 
                                      method: :patch, 
                                      class: "button tiny success",
                                      confirm: "Mark this transaction as successful?" %>
                          <%= link_to "Mark Failed", super_admin_billing_mark_transaction_failed_path(transaction), 
                                      method: :patch, 
                                      class: "button tiny alert",
                                      confirm: "Mark this transaction as failed?" %>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <div class="pagination-container">
            <%= paginate @transactions, theme: 'twitter-bootstrap-4' %>
          </div>
        <% else %>
          <div class="empty-state">
            <h4>No transactions found</h4>
            <p>No transactions match your current filters.</p>
            <%= link_to "Clear Filters", super_admin_billing_transactions_path, class: "button secondary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Transaction Statistics -->
<div class="row">
  <div class="medium-6 columns">
    <div class="card">
      <div class="card-header">
        <h3>Daily Revenue (Last 30 Days)</h3>
      </div>
      <div class="card-body">
        <% daily_revenue = @transactions.successful.where(created_at: 30.days.ago..Time.current).group_by_day(:created_at).sum(:amount) %>
        <% if daily_revenue.any? %>
          <div class="chart-container">
            <canvas id="dailyRevenueChart" width="400" height="200"></canvas>
          </div>
        <% else %>
          <p class="no-data">No revenue data available for the last 30 days.</p>
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="medium-6 columns">
    <div class="card">
      <div class="card-header">
        <h3>Payment Gateway Distribution</h3>
      </div>
      <div class="card-body">
        <% gateway_stats = @transactions.group(:payment_gateway).group(:status).count %>
        <% if gateway_stats.any? %>
          <div class="gateway-stats">
            <% @transactions.group(:payment_gateway).count.each do |gateway, total| %>
              <div class="gateway-stat">
                <div class="gateway-header">
                  <strong><%= gateway.humanize %></strong>
                  <span class="gateway-total"><%= total %> transactions</span>
                </div>
                <div class="gateway-breakdown">
                  <% ['successful', 'failed', 'pending'].each do |status| %>
                    <% count = gateway_stats[[gateway, status]] || 0 %>
                    <% percentage = total > 0 ? (count.to_f / total * 100).round(1) : 0 %>
                    <div class="status-bar">
                      <span class="status-label"><%= status.humanize %>:</span>
                      <div class="status-progress">
                        <div class="status-fill <%= status %>" style="width: <%= percentage %>%"></div>
                        <span class="status-text"><%= count %> (<%= percentage %>%)</span>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="no-data">No payment gateway data available.</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
<% if daily_revenue.any? %>
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('dailyRevenueChart').getContext('2d');
    const dailyData = <%= daily_revenue.to_json.html_safe %>;
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: Object.keys(dailyData),
        datasets: [{
          label: 'Daily Revenue',
          data: Object.values(dailyData),
          borderColor: '#007cba',
          backgroundColor: 'rgba(0, 124, 186, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '$' + value.toLocaleString();
              }
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'Revenue: $' + context.parsed.y.toLocaleString();
              }
            }
          }
        }
      }
    });
  });
<% end %>
</script>

<style>
.summary-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  border-left: 4px solid;
}

.summary-card.success {
  border-left-color: #4CAF50;
}

.summary-card.danger {
  border-left-color: #f44336;
}

.summary-card.warning {
  border-left-color: #ff9800;
}

.summary-card.primary {
  border-left-color: #007cba;
}

.summary-number {
  font-size: 2em;
  font-weight: bold;
  margin-bottom: 5px;
}

.summary-card.success .summary-number {
  color: #4CAF50;
}

.summary-card.danger .summary-number {
  color: #f44336;
}

.summary-card.warning .summary-number {
  color: #ff9800;
}

.summary-card.primary .summary-number {
  color: #007cba;
}

.summary-label {
  font-weight: bold;
  color: #333;
  margin-bottom: 5px;
}

.summary-count {
  color: #666;
  font-size: 0.9em;
}

.filters-form {
  margin: 0;
}

.filter-actions {
  margin-top: 15px;
  text-align: center;
}

.filter-actions .button {
  margin: 0 10px;
}

.table-container {
  overflow-x: auto;
}

.transactions-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9em;
}

.transactions-table th,
.transactions-table td {
  padding: 12px 8px;
  text-align: left;
  border-bottom: 1px solid #eee;
}

.transactions-table th {
  background-color: #f8f9fa;
  font-weight: bold;
  color: #666;
  position: sticky;
  top: 0;
}

.transaction-row.successful {
  background-color: rgba(76, 175, 80, 0.05);
}

.transaction-row.failed {
  background-color: rgba(244, 67, 54, 0.05);
}

.transaction-row.pending {
  background-color: rgba(255, 152, 0, 0.05);
}

.transaction-id {
  font-family: monospace;
  font-weight: bold;
  color: #666;
}

.account-info strong {
  display: block;
  color: #333;
}

.account-id {
  color: #999;
  font-size: 0.8em;
}

.plan-info strong {
  display: block;
  color: #333;
}

.plan-limit {
  color: #666;
  font-size: 0.8em;
}

.no-plan {
  color: #999;
  font-style: italic;
}

.amount-info .amount {
  display: block;
  color: #333;
  font-size: 1.1em;
}

.currency {
  color: #666;
  font-size: 0.8em;
}

.failure-reason {
  display: block;
  color: #f44336;
  font-size: 0.8em;
  margin-top: 2px;
}

.gateway {
  text-transform: capitalize;
  color: #333;
}

.gateway-id {
  font-family: monospace;
  color: #666;
  font-size: 0.9em;
}

.no-gateway-id {
  color: #999;
  font-style: italic;
}

.date-info strong {
  display: block;
  color: #333;
}

.time {
  color: #666;
  font-size: 0.8em;
}

.action-buttons {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
}

.pagination-container {
  margin-top: 20px;
  text-align: center;
}

.chart-container {
  position: relative;
  height: 200px;
}

.gateway-stats {
  space-y: 20px;
}

.gateway-stat {
  margin-bottom: 20px;
  padding: 15px;
  background-color: #f8f9fa;
  border-radius: 6px;
}

.gateway-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.gateway-total {
  color: #666;
  font-size: 0.9em;
}

.gateway-breakdown {
  space-y: 8px;
}

.status-bar {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
}

.status-label {
  width: 80px;
  font-size: 0.9em;
  color: #666;
}

.status-progress {
  flex: 1;
  position: relative;
  height: 20px;
  background-color: #e0e0e0;
  border-radius: 10px;
  overflow: hidden;
  margin-left: 10px;
}

.status-fill {
  height: 100%;
  transition: width 0.3s ease;
}

.status-fill.successful {
  background-color: #4CAF50;
}

.status-fill.failed {
  background-color: #f44336;
}

.status-fill.pending {
  background-color: #ff9800;
}

.status-text {
  position: absolute;
  top: 50%;
  left: 10px;
  transform: translateY(-50%);
  font-size: 0.8em;
  font-weight: bold;
  color: #333;
}

.empty-state,
.no-data {
  text-align: center;
  color: #666;
  padding: 40px 20px;
}

.empty-state h4 {
  margin-bottom: 10px;
  color: #333;
}

.card {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}

.card-header {
  padding: 15px 20px;
  border-bottom: 1px solid #eee;
  background-color: #f8f9fa;
}

.card-header h3 {
  margin: 0;
  font-size: 1.2em;
}

.card-body {
  padding: 20px;
}

.badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
}

.badge.successful {
  background-color: #4CAF50;
  color: white;
}

.badge.failed {
  background-color: #f44336;
  color: white;
}

.badge.pending {
  background-color: #ff9800;
  color: white;
}
</style>